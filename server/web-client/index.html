<!DOCTYPE HTML>
<html lang='en'>
<head>
   <!--
    Copyright 2012 Rodja Trappe

    This file is part of cross copy.

    cross copy is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    cross copy is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with cross copy.  If not, see <http://www.gnu.org/licenses/>.
-->

   <meta http-equiv='Content-Type' content='text/html; charset=utf-8' >
   <meta name='format-detection' content='telephone=no'>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31324545-1']);
  _gaq.push(['_setDomainName', 'crosscopy-trappe.dotcloud.com']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();


function trackEvent(category, action){
  _gaq.push(['_trackEvent', category, action]);
}


</script>

   <title>cross copy</title>
   
            <link rel='stylesheet' href='styles.css' type='text/css' />
            <script src='jquery-1.7.1.min.js' type='text/javascript'></script>
            
            <script type="text/javascript">


var server = "/api";
var history;
var secret;
var request;

function listen(force){
if (request != undefined)
console.log(request.statusText);
  if (request != undefined && !force && secret === encodeURI($('#secret').val())) 
    return;

  secret = encodeURI($('#secret').val());

  if (request != undefined)
    request.abort();

  if (secret === undefined || secret.length == 0)
    return;

  var oldPastes = history[secret];
  if (oldPastes == null)
    oldPastes = [];

  if (!force)
    $('#received').fadeOut(function(){
      $(this).empty();
      $.each(oldPastes, function(i,e){ 
         var $li = $('<li>' + e +'</li>\n');
         $('#received').append($li);
      });
      $('#received').fadeIn();
    });

  $('#step-2 h2').css({color: ''}); 
  
  if (request != undefined)
      request.abort();
    
  request = $.ajax({
      url: server + '/' + secret,
      success: function(response){
        trackEvent('succsess', 'GET');
        trackEvent('data', 'received');
        paste(response);
      },
      error: function(xhr, status){
        trackEvent('error', 'GET');
	    },
      complete: function(xhr, status){
	      if (status != "abort"){
          setTimeout("listen()", 50);
        }
      }
  });
}

function paste(data){

  var $li = $('<li>' + data +'</li>\n');
  $('#received').prepend($li);
  $li.hide().slideDown();

  var pastes = [];
  $("ul li").each(function() { pastes.push($(this).text()) });
  history[secret] = pastes;
  localStorage.setItem('history', JSON.stringify(history, null, 2));
}

$(document).ready(function() {

  $('#secret').focus();

  history = JSON.parse(localStorage.getItem('history'));
  if (history == null) history = {};

  var secrets = JSON.parse(localStorage.getItem('secrets'));
  if (secrets != null && secrets.length > 0){
    $('#secret').val(secrets[0]); 
    listen();
  }
  

  $('#secret').keyup(function (e){
    listen();
  });

  $('#data').keyup(function (e){
  
    if (e.which != 13)
      return;

    if (secret.length == 0){
      $('#step-2 h2').css({color: '#f00'});
      $('#step-1 h2').css({color: ''});
      return;
    }

    if (request != undefined)
      request.abort();

    trackEvent('data', 'submitted');

    $.ajax({
	      url: server + '/' + secret,
	      type: 'PUT',
        processData: false,
        crossDomain: false,
	      data: $('#data').val(),
        dataType: "text",
        success: function(response){
          if (response == 0){
            $('#step-1 h2').css({color: '#f00'});
            trackEvent('error', 'lonley PUT');
          }
          else {
            trackEvent('succsess', 'GET');
            $('#step-1 h2').css({color: ''});       
            paste($('#data').val());
            localStorage.setItem('secrets', JSON.stringify([secret], null, 2));
          }
        },
	      error: function(xhr, status){
          $('#step-1 h2').css({color: '#f00'});
          trackEvent('error', 'PUT');
	      },
	      complete: function(xhr, status){
          console.log('completed');		      
          listen(true);
	      }
	  });

  });
  
});

</script>

</head>

<body>

<a href="http://github.com/rodja/cross-copy"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/camo.github.com/71eeaab9d563c2b3c590319b398dd35683265e85/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub"></a>

  <div id="wrapper">
    <h1>cross copy</h1>

    <div id="step-1" class="step">
      <h2><span class="num">1</span> open this page on different devices</h2>
    </div>

    <div id="step-2" class="step">
      <h2><span class="num">2</span> enter the same secret</h2>
      <input name="secret" id="secret" type="text" size="30" placeholder="">
    </div>

    <div class="step">
      <h2><span class="num">3</span> enter text and press return</h2>
    <input name="data" id="data" type="text" size="30" placeholder="">
    </div>

    <div class="step">
      <h2><span class="num">4</span> see cross copied text</h2>
      <ul id="received"></ul>
    </div>
  </div>
</body>
</html>


<!DOCTYPE HTML>
<html lang='en'>
<head>
   <!--
    Copyright 2012 Rodja Trappe

    This file is part of cross copy.

    cross copy is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    cross copy is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with cross copy.  If not, see <http://www.gnu.org/licenses/>.
-->

   <meta http-equiv='Content-Type' content='text/html; charset=utf-8' >
   <meta name='format-detection' content='telephone=no'>

<link href='http://fonts.googleapis.com/css?family=Varela' rel='stylesheet' type='text/css'>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31324545-1']);
  _gaq.push(['_setDomainName', 'cross-copy.net']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();


function trackEvent(category, action){
  _gaq.push(['_trackEvent', category, action]);
}


</script>

   <title>cross copy</title>
   
            <link rel='stylesheet' href='styles.css' type='text/css' />
            <link rel='stylesheet' href='fileuploader/fileuploader.css' type='text/css' />
            <script src='jquery-1.7.1.min.js' type='text/javascript'></script>
            <script src='jquery.autosize-min.js' type='text/javascript'></script>
            <script src='fileuploader/fileuploader.js' type='text/javascript'></script>
            
            <script type="text/javascript">


var server = "/api";
var history;
var secret;
var request;
var watchRequest;
var numberOfListeners = 1;

function listen(){

  secret = encodeURI($('#secret').val());

  if (request != undefined)
    request.abort();

  if (secret === undefined || secret.length == 0)
    return;

  $('#step-2 h2').css({color: ''}); 
  
  if (uploader != undefined){
    uploader._options.action = "api/" + secret + "/";
    uploader._handler._options.action = uploader._options.action;
  }

  request = $.ajax({
      url: server + '/' + secret,
      success: function(response){
        trackEvent('succsess', 'GET');
        trackEvent('data', 'received');
        paste(response, "in");
      },
      error: function(xhr, status){
        trackEvent('error', 'GET');
	    },
      complete: function(xhr, status){
        if (status != "abort"){
          setTimeout("listen()", 50);
        }
      }
  });
}

function watch(){
  if (watchRequest != undefined)
    watchRequest.abort();

  watchRequest = $.ajax({
      url: server + '/' + secret + '?watch=listeners&count=' + numberOfListeners,
      success: function(response){
  console.log(response);
        trackEvent('watch_listeners', 'changed');
        numberOfListeners = response;
        $('#step-1 p').text(response).hide().slideDown(1000);
      },
      error: function(xhr, status){
        trackEvent('error', 'GET listeners count');
	    },
      complete: function(xhr, status){
        if (status != "abort"){
          setTimeout("watch()", 50);
        }
      }
  });
}


function paste(data, direction){

  if (data.indexOf('/api/' + secret) != -1)
    data = '<a href="' + data + '">' + data.substring(('/api/' + secret).length + 1) + '</a>';
  
  var $li = $('<li>' + data +'</li>\n');
  $li.addClass(direction);
  $('#received').prepend($li);
  $li.hide().slideDown();

  var pastes = [];
  $("ul li").each(function() { 
    var direction = $(this).attr('class');    
    if (direction === 'in' || direction === 'out')   
      pastes.push( {'direction': direction, 'msg' : $(this).text() });
  });
  history[secret] = pastes;
  localStorage.setItem('history', JSON.stringify(history, null, 2));
}

function share(text){

  if (secret.length == 0){
    $('#step-2 h2').css({color: '#f00'});
    $('#step-1 h2').css({color: ''});
    return;
  }

  if (request != undefined)
    request.abort();

  trackEvent('data', 'submitted');

  $.ajax({
      url: server + '/' + secret,
      type: 'PUT',
      processData: false,
      crossDomain: false,
      data: text,
      dataType: "text",
      success: function(response){
        if (response == 0){
          $('#step-1 h2').css({color: '#f00'});
          trackEvent('error', 'lonley PUT');
        }
        else {
          trackEvent('succsess', 'GET');
          $('#step-1 h2').css({color: ''});       
          paste(text, "out");
          localStorage.setItem('secrets', JSON.stringify([secret], null, 2));
        }
      },
      error: function(xhr, status){
        $('#step-1 h2').css({color: '#f00'});
        trackEvent('error', 'PUT');
      },
      complete: function(xhr, status){
        setTimeout("listen()", 50);
      }
  });
}

$(document).ready(function() {

  history = JSON.parse(localStorage.getItem('history'));
  if (history == null) history = {};

  var secrets = JSON.parse(localStorage.getItem('secrets'));
  if (secrets != null && secrets.length > 0){
    $('#secret').val(secrets[0]); 
    listen();
    watch();
    showHistory();
  }
 
  $('#secret').focus();
  $('#secret').select();

  $('#secret').keyup(function (e){
    if (secret == encodeURI($('#secret').val()))
      return;

    listen();

    watch();

    showHistory();
  });

  $('#data').keyup(function (e){
    
    if (e.which != 13)
      return;
    share($('#data').val());    
  });
  $('#data').keypress(function(e){
    if (e.which == 13)
      e.preventDefault();
  });
  $('#data').autosize();
  
});

function showHistory(){

  var oldPastes = history[secret];
  if (oldPastes == null)
    oldPastes = [];

  $('#received').fadeOut(function(){
    $(this).empty();
    $.each(oldPastes, function(i,e){
       var d = e.direction ? e.direction : 'in';
       var $li = $('<li class="' + d + '">' + (e.msg != undefined ? e.msg : e) +'</li>\n');
      $('#received').append($li);
    });
    if (oldPastes.length > 0)
      $('#received').prepend($('<li class="new-session">locally stored history for this secret</li>'));
    $('#received').fadeIn();
  });
}

function showWhy(){
  $('#explenation a').fadeOut(200, function(){
    $('#why').slideDown(500);
  });
}

</script>

<script>        
        var uploader;
        function createUploader(){            
            uploader = new qq.FileUploader({
                element: document.getElementById('upload'),
                action: 'api/' + secret + '/',
                debug: false,
                onSubmit: function(id, fileName){},
                onProgress: function(id, filename, loaded, total){
                  $('.qq-upload-progress').width((loaded/total * 100).toString() +"%");
                },
                onComplete: function(id, filename, response){
                  trackEvent('succsess', 'POST');
                  share(response.url);
                },
                template: '<div class="qq-uploader">' + 
                '<div class="qq-upload-drop-area"><span>Drop files here to upload</span></div>' +
                  '<div class="qq-upload-button"><img src="fileuploader/upload.png"</img></div>' +
                  '' + 
                '</div><div class="qq-upload-progress"></div>',
                listElement: " "
            });           
        }
        
        // in your app create uploader as soon as the DOM is ready
        // don't wait for the window to load  
        window.onload = createUploader;     
    </script>    

</head>

<body>

<a href="http://github.com/rodja/cross-copy"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://a248.e.akamai.net/camo.github.com/71eeaab9d563c2b3c590319b398dd35683265e85/687474703a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub"></a>

  <div id="wrapper">
    <h1>cross copy</h1>

    <div id="content">
      <div id="explenation">      
        <p>
          ... can transfer stuff between devices<br/>
                <a href="javascript:void(0)" onclick="showWhy();">read "Why another tool?"</a>
        </p>
          <div id="why" style="display:none;">
            <strong>Why another tool?</strong><br/><br/>

            No need to login.</br>          
            No need to install an application.</br>
            No need to explain much.<br/>
            Just agree on a code word!
          </div>
        </p>
      </div>

      <div id="step-1" class="step">
        <h2><span class="num">1</span> open this page on different devices</h2>
        <p style="display:hidden"></p>     
     </div>

      <div id="step-2" class="step">
        <h2><span class="num">2</span> enter the same secret</h2>
        <input name="secret" id="secret" type="text" size="30" placeholder="">
      </div>

      <div  id="step-3" class="step">
        <h2><span class="num">3</span> enter text and press return</h2>
        <textarea name="data" id="data" rows=1 type="text" size="30" placeholder="or pick a file"></textarea>
        <div id="upload"></div>      
      </div>

      <div id="step-4" class="step">
        <h2><span class="num">4</span> wait for appearing cross copies</h2>
        <ul id="received"></ul>
      </div>
    </div>
  </div>
</body>
</html>


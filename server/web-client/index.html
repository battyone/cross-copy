<!DOCTYPE HTML>
<html lang='en'>
<head>
   <meta http-equiv='Content-Type' content='text/html; charset=utf-8' >
   <meta name='format-detection' content='telephone=no'>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31324545-1']);
  _gaq.push(['_setDomainName', 'crosscopy-trappe.dotcloud.com']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();


function trackEvent(category, action){
  _gaq.push(['_trackEvent', category, action]);
}


</script>

   <title>cross copy</title>
   
            <link rel='stylesheet' href='styles.css' type='text/css' />
            <script src='jquery-1.7.1.min.js' type='text/javascript'></script>
            
            <script type="text/javascript">


var server = "/api";

var request;

function listen(){
  var secret = encodeURI($('#secret').val());

  if (request != undefined)
    request.abort();

  if (secret === undefined || secret.length == 0)
    return;

  $('#step-2 h2').css({color: ''}); 
  
  if (request != undefined)
      request.abort();
    
  request = $.ajax({
      url: server + '/' + secret,
      success: function(response){
        trackEvent('succsess', 'GET');
        trackEvent('data', 'received');
    $('#received').fadeOut(100, function(){$(this).text(response).fadeIn(300)});
	      setTimeout("listen()", 50);
      },
      error: function(xhr, status){
        trackEvent('error', 'GET');
	      if (status != "abort"){
          setTimeout("listen()", 50);
        }
	    },
      complete: function(xhr, status){
      }
  });
}

$(document).ready(function() {

  $('#secret').keyup(function (e){
    listen();
  });

  $('#data').keyup(function (e){
  
    if (e.which != 13)
      return;

    var secret = $('#secret').val();  
    if (secret.length == 0){
      $('#step-2 h2').css({color: '#f00'});
      $('#received').fadeOut();   
      return;
    }

    if (request != undefined)
      request.abort();

    trackEvent('data', 'submitted');

    $.ajax({
	      url: server + '/' + $('#secret').val(),
	      type: 'PUT',
        processData: false,
        crossDomain: false,
	      data: $('#data').val(),
        dataType: "text",
        success: function(response){
          if (response == 0){
            $('#step-1 h2').css({color: '#f00'});
            $('#received').fadeOut();
            trackEvent('error', 'lonley PUT');
          }
          else {
            trackEvent('succsess', 'GET');
            $('#step-1 h2').css({color: ''});       
            $('#received').fadeOut(100, function(){$(this).text($('#data').val()).fadeIn(300)});
          }
        },
	      error: function(xhr, status){
          trackEvent('error', 'PUT');
	      },
	      complete: function(xhr, status){
		      listen();
	      }
	  });

  });
  
});

</script>

</head>

<body>
  <div id="wrapper">
    <h1>cross copy</h1>

    <div id="step-1" class="step">
      <h2><span class="num">1</span> open this page on different devices</h2>
    </div>

    <div id="step-2" class="step">
      <h2><span class="num">2</span> choose a common secret</h2>
      <input name="secret" id="secret" type="text" size="30" placeholder="">
    </div>

    <div class="step">
      <h2><span class="num">3</span> enter text and press return</h2>
    <input name="data" id="data" type="text" size="30" placeholder="">
    </div>

    <div class="step">
      <h2><span class="num">4</span> see cross copied text</h2>
      <ul id="received"></ul>
    </div>
  </div>
</body>
</html>

